<!DOCTYPE html>
<html>
  <head>
    <title>Sonnet - One Team One Delivery</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/photon.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
     <style>
		html, body {
		   width: 100%;
		   height: 100%;
		   margin: 0;
		   padding: 0;
		}
		.tab-content, .tab-pane{
			width:100%; 
			height:100%;
			
		}
	</style>
    <!-- Javascript -->
	<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="js/jquery-3.2.1.min.js" charset="utf-8"></script>
	
	<script src="js/bootstrap.min.js" charset="utf-8"></script>
	<script>if (window.module) module = window.module;</script>
	
	<!--App files-->
	<script src="js/menu.js" charset="utf-8"></script>
  </head>
  <body>
    <div class="window">

      <!-- .toolbar-header sits at the top of your app -->
    <header class="toolbar toolbar-header">
        <h1 class="title">Sonnet <span class='indicator'></span></h1>
    </header>
	<div>
	  <!-- Nav tabs -->
	  <ul class="nav nav-tabs" role="tablist">
		<li role="presentation" class="active"><a href="#hub" aria-controls="home" role="tab" data-toggle="tab">Hub </a></li>
		<li role="presentation"><a href="#hangout" aria-controls="profile" role="tab" data-toggle="tab">Hangout</a></li>

		<li role="presentation"><a href="#" class="add-tab" aria-controls="add" role="tab" ><span class="glyphicon glyphicon-plus"></span>Add Plot</a></li>
	  </ul>

	</div>
	
	<!-- Your app's content goes inside .window-content -->
      <div class="window-content">
	    <!-- Tab panes -->
		  <div class="tab-content">
			<div role="tabpanel" class="tab-pane active" id="hub"> <webview id="foo" src="https://www.wpoets.com/hub" autosize="on" style="display:flex; min-width:640px; min-height:700px" ></webview></div>
			<div role="tabpanel" class="tab-pane" id="hangout">  <webview id="foo" src="https://hangouts.google.com/" autosize="on" style="display:flex; min-width:640px; min-height:700px"></webview></div>

			
		  </div>
      </div>
    </div>
	<script>
	  var electron = require('electron');
	  var currentWindow = electron.remote.getCurrentWindow();
	  const {shell} = require('electron');
		
	  const Store = require('electron-store');
	  const store = new Store();
	  var sonnet = store.get('sonnet',{"items":[]});
	  jQuery.each(sonnet.items, function( key, value ) {
		  
			var id = jQuery(".nav-tabs").children().length; //think about it ;)
			var tabId = 'contact_' + id;
			jQuery('.add-tab').closest('li').before('<li key="'+key+'" label="'+value.label+'" url="'+value.url+'"><a href="#' + tabId + '" class="tab'+id+'">'+value.label+'</a> <span> x </span></li>');
			jQuery('.tab-content').append('<div class="tab-pane" id="' + tabId + '"><webview id="wv'+id+'" src="'+value.url+'" autosize="on" style="min-width:1250px; min-height:700px"></webview></div>');
			
		})
		
	  jQuery(".nav-tabs").on("click", "a", function (e) {
		    
			e.preventDefault();
			if (!jQuery(this).hasClass('add-tab')) {
				jQuery(this).tab('show');
				
				currentWindow.setTitle(jQuery(this).html());
			}
		})
		.on("click", "span", function () {
			var anchor = jQuery(this).siblings('a');
		
			
			jQuery(anchor.attr('href')).remove();
			p_li=jQuery(this).parent();
			if(p_li.attr('key') !== ''){
				sonnet.items.splice(p_li.attr('key'),1);
				store.set('sonnet',sonnet);
			}
			p_li.remove();
			
			jQuery(".nav-tabs li").children('a').first().click();
		});

		jQuery('.add-tab').click(function (e) {
			  
			e.preventDefault();
			var id = jQuery(".nav-tabs").children().length; //think about it ;)
			var tabId = 'contact_' + id;
			jQuery(this).closest('li').before('<li key="" label="" url=""><a href="#' + tabId + '" class="tab'+id+'">New Tab</a> <span> x </span></li>');
			jQuery('.tab-content').append('<div class="tab-pane" id="' + tabId + '"><webview id="wv'+id+'" src="file://' + __dirname + '/new-tab.html" preload="./new-tab.js" autosize="on" style="min-width:1250px; min-height:700px"></webview></div>');
			
		    jQuery('.nav-tabs li:nth-child(' + id + ') a').click();
		    var wv=document.querySelector('#wv'+id);
		    wv.addEventListener("dom-ready", function() {
				//wv.openDevTools();
			});	
			wv.addEventListener("ipc-message", function (e) {
			 
			  if (e.channel === "tab-data") {
				//I have a json obejct
				// add value to it
				sonnet.items.push(e.args[0]);
				//save
				store.set('sonnet',sonnet);
				
				$(".nav.nav-tabs li.active").attr('key',(id-3));
				$(".nav.nav-tabs li.active").attr('label',e.args[0].label);
				$(".nav.nav-tabs li.active").attr('url',e.args[0].url);
				$(".nav.nav-tabs li.active a").html(e.args[0].label);
				currentWindow.setTitle(e.args[0].label);
				this.loadURL(e.args[0].url);
			  }
			 
			});
			wv.addEventListener('did-start-loading', function(){
				$('.indicator').html('loading...');
			})
			wv.addEventListener('did-stop-loading',  function(){
				$('.indicator').html('');
			})
			
			wv.addEventListener('new-window', (e) => {
			  const protocol = require('url').parse(e.url).protocol
			  if (protocol === 'http:' || protocol === 'https:') {
				shell.openExternal(e.url)
			  }
			});
			
		});
		
	
  onload = () => {

    const webview = document.querySelector('webview')
    const indicator = document.querySelector('.indicator')

    const loadstart = () => {
      indicator.innerText = 'loading...'
    }

    const loadstop = () => {
      indicator.innerText = ''
    }

    webview.addEventListener('did-start-loading', loadstart)
    webview.addEventListener('did-stop-loading', loadstop)
	webview.addEventListener('new-window', (e) => {
	  const protocol = require('url').parse(e.url).protocol
	  if (protocol === 'http:' || protocol === 'https:') {
		shell.openExternal(e.url)
	  }
	});
  }
  
  
  
</script>
  </body>
</html>
